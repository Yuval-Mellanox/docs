<!-- First, get a list of versions for this product and map it to the version landing page -->
{{range where .Site.Sections "Params.product" .Page.Params.product }}
    {{  $.Scratch.SetInMap "version_page_map" (string .Params.version) .Page.RelPermalink }}
{{ end }}

<!-- Now check to see if this page exists for a version and update the map -->
{{ range where (where .Site.Pages "Params.title" .Page.Title) ".Page.Params.product" .Page.Params.product  }}
    {{  $.Scratch.SetInMap "version_page_map" (string .Params.version) .Page.RelPermalink }}
{{ end }}

<div id="product-nav" class="flex">
    <div class="menu-container">
        <!-- generates subnav memu from config.toml -->
        {{ $currentProduct := $.Page.Params.product}}
        <ul>
            {{ range .Site.Menus.subnav}}
                <li {{ with eq $currentProduct .Title }} class = "active" {{ end }}><a href = {{.URL}} >{{.Title}} </a> </li>
            {{ end }}
        </ul>
        <div class="productMenu-dropdown">
            <div class="dropdown">
                <button class="btn btn-secondary dropdown-toggle" type="button" id="siteMenuButton" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                    Cumulus Linux
                </button>
                <ul class="dropdown-menu" aria-lablledby="siteMenuButton">
                    {{ range .Site.Menus.subnav}}
                        <li class="dropdown-item"><a href={{.URL}}>{{.Title}} </a> </li>
                    {{ end }}
                    <li>
                        <a href="#" class="dropdown-item dropdown-toggle" id="productsDropdown" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">Products</a>
                        <ul class="dropdown-menu multi-level" aria-lablledby="productsDropdown" style="display:none;">
                            {{range .Site.Menus.dropnav}}
                                <li><a class="dropdown-item" href={{.URL}}>{{.Title}}</a></li>
                            {{ end }}
                        </ul>
                    </li>
                </ul>
            </div>
        </div>
    </div>

    <div class="search-container">
        <div class="screen-layout">
            <a class="default" href="#">
                <svg width="22" height="22" viewBox="0 0 22 22"><g transform="translate(1 1)" stroke="#FFF" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"><rect x=".435" y=".432" width="19.13" height="19.13" rx="1"/><path d="M6.522 5.65v13.913M13.478 5.663v13.9M.435 5.65h19.13"/></g></svg>
            </a>
            <a class="sb-right" href="#">
                <svg width="22" height="22" viewBox="0 0 22 22"><g transform="translate(1 1)" stroke="#FFF" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"><rect x=".435" y=".432" width="19.13" height="19.13" rx="1"/><path d="M.435 5.65h19.13M13.478 5.65v13.913"/></g></svg>
            </a>
            <a class="sb-left" href="#">
                <svg width="22" height="22" viewBox="0 0 22 22"><g transform="translate(1 1)" stroke="#FFF" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"><rect x=".435" y=".432" width="19.13" height="19.13" rx="1"/><path d="M.435 5.65h19.13M6.522 5.686v13.877"/></g></svg>
            </a>
            <a class="no-sb" href="#">
                <svg width="22" height="22" viewBox="0 0 22 22"><g transform="translate(1 1)" stroke="#FFF" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"><rect x=".435" y=".432" width="19.13" height="19.13" rx="1"/><path d="M.435 5.65h19.13"/></g></svg>
            </a>
        </div>
        <form action="/search/" method="GET">
            <div id="doc-search-box">
                <input type="text" name="q" class="doc-search-input" placeholder="Search">
                <!-- <span>
                    <button type="submit">
                        <img src={{"icons/search_20x20.svg" | absURL }} alt="">
                    </button>
                </span> -->
            </div>
        </form>
        {{- if .Params.version -}}
        <div id="dropdown" class="dropdown">
            <button class="btn" type="button" id="dropdownMenuButton">
                    v{{.Page.Params.version}}
            </button>
            <div class="dropdown-menu" aria-labelledby="dropdownMenuButton">
                <!-- Sort our list of versions so it's high to low -->
                {{ range sort (where .Site.Sections "Params.product" .Page.Params.product) ".Page.Params.version" "desc"}}
                    <!-- The version is the key in version_links. Get the Permalink of the page stored as a value  -->
                    {{ $ver := "" }}
                    {{ if not ($.Scratch.Get "version_page_map") }}
                        <a class="dropdown-item" href="{{ .Page.RelPermalink }}">v{{.Page.Params.version}} </a>
                    {{ else }}
                        <a class="dropdown-item" href="{{index ($.Scratch.Get "version_page_map") (string .Page.Params.version)}}">v{{.Page.Params.version}} </a>
                    {{ end }}
                {{ end }}
            </div>
        </div>
        {{- end -}}
    </div>
</div>